
<!DOCTYPE html>
<html>

<head>
  <title>LeadGenX | Canadian Women in Cybersecurity 2022 - Powered by siberX</title>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsqr@1.1.1/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="./toast.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="./stylesheet.css">
  <style type="text/css">
  #qrcode-scanner {
    top: 0;
    margin: 0;
    width: 100%;
  }

  #qrcode-scanner video {
	width: 100%;
    max-width: 100%;
  }
  </style>
</head>

<body>

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="min-width: 750px !important; margin: auto;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">QR Code Scanner</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
	  </div>
      <div class="modal-body">
		    <div id="qrcode-scanner">
          <div style="top: 0px; width: 100%; margin: auto; position: relative;">
            <div class="circle-loader" style="position: absolute; top: 80px; left: 295px; margin: auto;" id="circ">
              <div class="checkmark draw"></div>
            </div>
            <div id="status">Waiting for camera...</div>
            <div name="pane-webcam" style="height: 100%; position: relative;">
              <video id="video" width="700" style="min-height: 200px; margin-bottom: 10px; border-radius: 5px;"></video>
              <div class="input-group" style="margin-bottom: 20px;">
                <div class="input-group-prepend">
                    <span class="input-group-text">Select Camera</span>
                </div>
                <select id="sourceSelect" class="form-control"></select>
                <button type="button" class="btn btn-primary" id="startButton" style="margin-left: 10px;">Start Camera</button>
              </div>
            </div>
          </div>
        </div>
        <div class="input-group" id="comment-form">
          <div class="input-group-prepend">
            <span class="input-group-text">Comments</span>
          </div>
          <textarea class="form-control" aria-label="With textarea" id="comments"></textarea>
        </div>
      </div>
      <div class="modal-footer" style="margin:auto;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submit_button">Submit</button>
      </div>
    </div>
  </div>
</div>

<div id="information" style="position: absolute; bottom: 20px; opacity: 50%;"> </div>
<div>
	<div id="banner"></div>

	<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter" id="launch" style="width: 350px; height: 90px; font-size: 20pt;">
	  Scan a QR Code
	</button>

</div>

<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
<script type="text/javascript">

  var security = "";
  var ticket_id = "";

    function decodeOnce(codeReader, selectedDeviceId) {
    codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {
        // properly decoded qr code
        console.log(result);

        var id = result.text.split(',');

        if (id[1] == undefined) {

            toastPopup('The QR code did not match the expected format.','danger');

        } else {

          security = id[0];
          ticket_id = id[1];

          $('#submit_button').prop('disabled', false);
          $('#comment-form').css('display', 'flex');
          $('.modal-footer').css('display', 'flex');
          $('#modalTitle').html('Add any optional comments and submit.');
          $('#qrcode-scanner').css('display','none');

        }
        
        $('#close-modal').click();
        codeReader.reset();



    }).catch((err) => {
        console.error(err)
    })
    }

    function decodeContinuously(codeReader, selectedDeviceId) {
    codeReader.decodeFromInputVideoDeviceContinuously(selectedDeviceId, 'video', (result, err) => {
        if (result) {
        // properly decoded qr code
        console.log('Found QR code!', result)
        }

        if (err) {
        // As long as this error belongs into one of the following categories
        // the code reader is going to continue as excepted. Any other error
        // will stop the decoding loop.
        //
        // Excepted Exceptions:
        //
        //  - NotFoundException
        //  - ChecksumException
        //  - FormatException

        if (err instanceof ZXing.NotFoundException) {
            console.log('No QR code found.')
        }

        if (err instanceof ZXing.ChecksumException) {
            console.log('A code was found, but it\'s read value was not valid.')
        }

        if (err instanceof ZXing.FormatException) {
            console.log('A code was found, but it was in a invalid format.')
        }
        }
    })
    }

    window.addEventListener('load', function () {
    let selectedDeviceId;
    const codeReader = new ZXing.BrowserQRCodeReader()
    console.log('ZXing code reader initialized')

    codeReader.getVideoInputDevices()
        .then((videoInputDevices) => {
        const sourceSelect = document.getElementById('sourceSelect')
        selectedDeviceId = videoInputDevices[0].deviceId
        if (videoInputDevices.length >= 1) {
            videoInputDevices.forEach((element) => {
            const sourceOption = document.createElement('option')
            sourceOption.text = element.label
            sourceOption.value = element.deviceId
            sourceSelect.appendChild(sourceOption)
            })

            sourceSelect.onchange = () => {
            selectedDeviceId = sourceSelect.value;
            };
        }

        document.getElementById('startButton').addEventListener('click', () => {

            //const decodingStyle = document.getElementById('decoding-style').value;

            //if (decodingStyle == "once") {
            decodeOnce(codeReader, selectedDeviceId);
            //} else {
            //decodeContinuously(codeReader, selectedDeviceId);
            //}

            console.log(`Started decode from camera with id ${selectedDeviceId}`)
        })

        /*document.getElementById('resetButton').addEventListener('click', () => {
            codeReader.reset()
            document.getElementById('result').textContent = '';
            console.log('Reset.')
        })*/

        })
        .catch((err) => {
        console.error(err)
        })
    })
</script>

  <script type="text/javascript">
    const this_url = new URL(window.location.href);
    var vendor_id = this_url.searchParams.get('vendorID');
    var p = document.getElementById('information');
    p.firstChild.nodeValue = 'Powered by siberX - Vendor ID: ' + vendor_id;
    
    function startProcess(security, ticket_id, comment) {
	
      console.log("vendor: ", vendor_id);
      jQuery.support.cors = true;
      $.ajax({
        url: "https://leadgen.siberxchange.live/generate-lead",
        type: "POST",
        crossDomain: true,
		dataType: "json",
        data: JSON.stringify({
		  tid: ticket_id,
          uid: security, //security_code
          vendorID: vendor_id, //vendor_id
		  comments: comment
        }),
        headers: {
          "accept": "application/json",
          "Access-Control-Allow-Origin": "*"
        },
		method: 'POST',
		contentType: "application/json; charset=utf-8",
        success: function(data) {
		  $('.close').click();
		  if (data.response == "Record not found") {
			toastPopup('No record matching the scanned QR code could be found.','danger');
		  } else {
			toastPopup('The scanned QR code was successfully processed.','success');
		  }
        },
        error: function (response) {
		  $('.close').click();
          toastPopup('There was a problem processing the scanned QR code.','danger');
        }
      });
    }
  
    // create QRCodeScanner instance
    //window.qrcodeScanner = new QRCodeScanner({ rootSelector: "#qrcode-scanner" });

    $(document).on("click", "#launch", function(e) {
	
        // open QRCodeScanner webcam scanner
      //var x = document.getElementById("button-container");
      //x.style.display = "none";
	  $('.circle-loader').removeClass('load-complete');
	  $('.checkmark').hide();
	  $('#submit_button').prop('disabled', true);
	  $('#modalTitle').html('QR Code Scanner');
	  $('#comment-form').css('display', 'none');
	  $('.modal-footer').css('display', 'none');

      /*qrcodeScanner.open((err, result) => {
	
		  const url = new URL(result.data);
		  security = url.searchParams.get('security_code');
		  ticket_id = url.searchParams.get('ticket_id');

		  $('#submit_button').prop('disabled', false);
		  $('#comment-form').css('display', 'flex');
		  $('.modal-footer').css('display', 'flex');
		  $('#modalTitle').html('Add any optional comments and submit.');
		  $('#qrcode-scanner').css('display','none');
		  // console.log("QRCodeScanner dataURL:", result.data);
		  //x.style.display = "inline-flex";
      });*/
    });
	
	$(document).on("click", "#submit_button", function(e) {
		var comment = $('#comments').val();
		  
		startProcess(security, ticket_id, comment);
		console.log("security_code: ", security, ", ticket_id: ", ticket_id, ", comments: ", comment);
		  $('#modalTitle').html('Powered by siberX');
		  $('#qrcode-scanner').css('display','flex');
		  $('.input-group').css('display', 'none');
		  $('.modal-footer').css('display', 'none');
		  $('#status').html('Processing your submission...');
		//$('.close').click();
		//$('.circle-loader').toggleClass('load-complete');
		//$('.checkmark').toggle();
		$('#comments').val('');
	});
</script>

</body>
</html>