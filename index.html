
<!DOCTYPE html>
<html>

<head>
  <title></title>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsqr@1.1.1/dist/jsQR.min.js"></script>
  <script type="text/javascript" src="./QRCodeScanner.js"></script>
  <link rel="stylesheet" href="./stylesheet.css">
  <style type="text/css">
  #qrcode-scanner {
    z-index: 9999;
    top: 0;
    margin: 0 auto;
    width: 700px;
    max-width: 700px;
  }

  #qrcode-scanner video {
	width: 100%;
    max-width: 100%;
	box-shadow: 0 10px 10px rgba(0, 0, 0, 0.1);
	background-color: #000000;
  }
  </style>
</head>

<body>
<div id="information" style="position: absolute; bottom:20px; opacity: 50%;"> </div>
<div><div id="banner"></div>
  <div id="button-container" style="height: 800px;">
    <ul class="wrapper">
      <li class="icon facebook" id="button2">
        <span style="align-items: center;" class="tooltip">Scan QRCode</span>
        <span><i class="fab fa-facebook-f"></i><img src="1200px-QR_icon.svg.png" class="qr" /></span>
      </li>
    </ul>
  </div>
  <div id="qrcode-scanner" style="display: none; padding-top: 20px; height: 800px;">
    <div name="pane-webcam" style="display: none; border-radius: 20px; height: 800px;">
      <video name="video" autoplay style="border-radius: 20px;"></video>
      <canvas name="canvas" style="display: none;"></canvas>
    </div>
    <div>
      <span name="lbl-processing" style="background: navy; color: white; padding: 4px; min-width:100%; font-weight: bold; display: none;">Processing ...</span>
    </div>
  </div>
</div>
  <script type="text/javascript">
    const this_url = new URL(window.location.href);
    var vendor_id = this_url.searchParams.get('vendorID');
    var p = document.getElementById('information');
    p.firstChild.nodeValue = 'Powered by siberX - Vendor ID: ' + vendor_id;
    
    function startProcess(security, ticket_id) {
      console.log("vendor: ", vendor_id);
      jQuery.support.cors = true;
      $.ajax({
        url: "http://3.99.74.9/generate-lead",
        type: "POST",
        crossDomain: true,
		dataType: "json",
        data: JSON.stringify({
		  tid: ticket_id,
          uid: security, //security_code
          vendorID: vendor_id //vendor_id
        }),
        headers: {
          "accept": "application/json",
          "Access-Control-Allow-Origin": "*"
        },
		method: 'POST',
		contentType: "application/json; charset=utf-8",
        success: function(data) {
		  if (data.response == "Record not found") {
			toastPopup('No record matching the scanned QR code could be found.','danger');
		  } else {
			toastPopup('The scanned QR code was successfully processed.','success');
		  }
        },
        error: function (response) {
          toastPopup('There was a problem processing the scanned QR code.','danger');
        }
      });
    }
  
    // create QRCodeScanner instance
    window.qrcodeScanner = new QRCodeScanner({ rootSelector: "#qrcode-scanner" });

    $(document).on("click", "#button2", function(e) {
        // open QRCodeScanner webcam scanner
      var x = document.getElementById("button-container");
      x.style.display = "none";

      qrcodeScanner.open((err, result) => {
    
      const url = new URL(result.data);
      var security = url.searchParams.get('security_code');
      var ticket_id = url.searchParams.get('ticket_id');
      
      startProcess(security, ticket_id);
      console.log("security_code: ", security, ", ticket_id: ", ticket_id);
      // console.log("QRCodeScanner dataURL:", result.data);
      x.style.display = "inline-flex";
      });
    });
  </script>

</body>
</html>