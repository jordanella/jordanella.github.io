
<!DOCTYPE html>
<html>

<head>
  <title>LeadGenX | Canadian Women in Cybersecurity 2022 - Powered by siberX</title>
  <meta charset="utf-8">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsqr@1.1.1/dist/jsQR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="./QRCodeScanner.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="./stylesheet.css">
  <style type="text/css">
  #qrcode-scanner {
    top: 0;
    margin: 0;
    width: 100%;
  }

  #qrcode-scanner video {
	width: 100%;
    max-width: 100%;
  }
  </style>
</head>

<body>

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="min-width: 750px !important; margin: auto;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">QR Code Scanner</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
	  </div>
      <div class="modal-body">
		  <div id="qrcode-scanner" style="display: none;">
			
        <div style="top: 0px; width: 100%; margin: auto; position: relative;">

        <div class="circle-loader" style="position: absolute; top: 80px; left: 295px; margin: auto;" id="circ">
          <div class="checkmark draw"></div>
        </div>
        <div id="status">Waiting for camera...</div>
          <div name="pane-webcam" style="height: 100%; position: relative;">
                  <video name="video" autoplay style="border-radius: 5px; z-index: 9999;" id="cam_holder"></video>
          <canvas name="canvas" style="display: none;"></canvas>
            <div>
              <span name="lbl-processing" style="background: navy; color: white; padding: 4px; min-width:100%; font-weight: bold; display: none;">Processing ...</span>
            </div>
          </div>
        </div>


			</div>
        <div class="input-group">
		  <div class="input-group-prepend">
			<span class="input-group-text">Comments</span>
		  </div>
		  <textarea class="form-control" aria-label="With textarea" id="comments"></textarea>
		</div>
      </div>
      <div class="modal-footer" style="margin:auto;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submit_button">Submit</button>
      </div>
    </div>
  </div>
</div>

<div id="information" style="position: absolute; bottom: 20px; opacity: 50%;"> </div>
<div>
	<div id="banner"></div>

	<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter" id="launch" style="width: 350px; height: 90px; font-size: 20pt;">
	  Scan a QR Code
	</button>

</div>
  <script type="text/javascript">
    const this_url = new URL(window.location.href);
    var vendor_id = this_url.searchParams.get('vendorID');
    var p = document.getElementById('information');
    p.firstChild.nodeValue = 'Powered by siberX - Vendor ID: ' + vendor_id;
    
    function startProcess(security, ticket_id, comment) {
	
      console.log("vendor: ", vendor_id);
      jQuery.support.cors = true;
      $.ajax({
        url: "https://leadgen.siberxchange.live/generate-lead",
        type: "POST",
        crossDomain: true,
		dataType: "json",
        data: JSON.stringify({
		  tid: ticket_id,
          uid: security, //security_code
          vendorID: vendor_id, //vendor_id
		  comments: comment
        }),
        headers: {
          "accept": "application/json",
          "Access-Control-Allow-Origin": "*"
        },
		method: 'POST',
		contentType: "application/json; charset=utf-8",
        success: function(data) {
		  $('.close').click();
		  if (data.response == "Record not found") {
			toastPopup('No record matching the scanned QR code could be found.','danger');
		  } else {
			toastPopup('The scanned QR code was successfully processed.','success');
		  }
        },
        error: function (response) {
		  $('.close').click();
          toastPopup('There was a problem processing the scanned QR code.','danger');
        }
      });
    }
  
    // create QRCodeScanner instance
    window.qrcodeScanner = new QRCodeScanner({ rootSelector: "#qrcode-scanner" });
    var security = "";
    var ticket_id = "";

    $(document).on("click", "#launch", function(e) {
	
        // open QRCodeScanner webcam scanner
      //var x = document.getElementById("button-container");
      //x.style.display = "none";
	  $('.circle-loader').removeClass('load-complete');
	  $('.checkmark').hide();
	  $('#submit_button').prop('disabled', true);
	  $('#modalTitle').html('QR Code Scanner');
	  $('.input-group').css('display', 'none');
	  $('.modal-footer').css('display', 'none');

      qrcodeScanner.open((err, result) => {
	
		  const url = new URL(result.data);
		  security = url.searchParams.get('security_code');
		  ticket_id = url.searchParams.get('ticket_id');

		  $('#submit_button').prop('disabled', false);
		  $('.input-group').css('display', 'flex');
		  $('.modal-footer').css('display', 'flex');
		  $('#modalTitle').html('Add any optional comments and submit.');
		  $('#qrcode-scanner').css('display','none');
		  // console.log("QRCodeScanner dataURL:", result.data);
		  //x.style.display = "inline-flex";
      });
    });
	
	$(document).on("click", "#submit_button", function(e) {
		var comment = $('#comments').val();
		  
		startProcess(security, ticket_id, comment);
		console.log("security_code: ", security, ", ticket_id: ", ticket_id, ", comments: ", comment);
		  $('#modalTitle').html('Powered by siberX');
		  $('#qrcode-scanner').css('display','flex');
		  $('.input-group').css('display', 'none');
		  $('.modal-footer').css('display', 'none');
		  $('#status').html('Processing your submission...');
		//$('.close').click();
		//$('.circle-loader').toggleClass('load-complete');
		//$('.checkmark').toggle();
		$('#comments').val('');
	});
  </script>

</body>
</html>