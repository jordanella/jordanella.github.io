
<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie-edge">
    <title>Canadian Women in Cybersecurity Check-in Application</title>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" media="print" href="./checkin.css">
    <script src="checkin.js"></script>

    <script type="text/javascript" src="./toast.js"></script>

    <!-- Generate QR -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    
    <link rel="stylesheet" href="./stylesheet.css">
    <link rel="stylesheet" href="./stylesheet2.css">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsqr@1.1.1/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>

    <script src="https://kit.fontawesome.com/f54adef315.js" crossorigin="anonymous"></script>
</head>

<body>

<!-- Modal -->
<div class="modal fade" id="scanModal" tabindex="-1" role="dialog" aria-labelledby="scanModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="margin: auto;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">QR Code Scanner</h5>
        <button type="button" id="close-modal" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
	  </div>
      <div class="modal-body">
		    <div id="qrcode-scanner">
          <div style="top: 0px; width: 100%; margin: auto; position: relative;">
            <div class="circle-loader" style="position: absolute; top: 90px; margin: auto;" id="circ">
              <div class="checkmark draw"></div>
            </div>
            <div id="status" style="position: absolute; top: 230px;">Waiting for camera...</div>
            <div name="pane-webcam" style="height: 100%; position: relative;">
              <video id="video" style="min-height: 340px; margin-bottom: 10px; border-radius: 5px;"></video>
              <div class="input-group" style="margin-bottom: 20px;">
                <div class="input-group-prepend">
                    <span class="input-group-text">Select Camera</span>
                </div>
                <select id="sourceSelect" class="form-control"></select>
                <button type="button" class="btn btn-primary" id="startButton" style="margin-left: 10px;">Start Camera</button>
              </div>
            </div>
          </div>
        </div>
        <div id="comment-form" style="display: none;">
          <div class="input-group">
            <div class="input-group-prepend">
              <span class="input-group-text">Comments</span>
            </div>
            <textarea class="form-control" aria-label="With textarea" id="comments"></textarea>
          </div>
          <div class="modal-footer" style="margin:auto;">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="submit_button">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Header -->
<div class="d-flex align-items-center justify-content-center hidden-print" style="margin-bottom: 20px; min-width: 100%; height: 140px; background-size: cover; background-image: linear-gradient(to top, #49066c33, #b94bbd33), url('https://wallpaperboat.com/wp-content/uploads/2020/08/08/51893/anime-scenery-01.jpg');">
  <p class="h2" id="projectAnchor" style="color: #ffffff; text-shadow: 2px 2px 4px #000000;">Canadian Women in Cybersecurity 2022 Lead Generation</p>
</div>

<!-- Content -->
<div class="container-fluid p-5" style="padding-top: 20px !important; padding-bottom: 0px !important; max-width: 900px; margin-bottom: 20px; padding-left: 10px !important; padding-right: 10px !important;">

  <!-- Cards -->
  <div class="card" style="margin-bottom: 20px;">
    <div class="card-body" style="text-align: left;">
      <div>
        <!-- <div id="banner"></div> -->
        <h4 style="text-align: left; margin-bottom: 20px;">Instructions</h4>

        <p>To ensure your results are recorded properly, ensure that the security code below matches the one you recieved in your lead generation email.</p>

        <div class="container" style="margin: 20px;">
            <div id="vendor_code_display" style="font-size: 20px; font-weight: bold; display: inline-flex; vertical-align: middle; margin-left: 20px;">fsd7fdsai</div>
        </div>

        <p>To capture a new lead, use the button below to begin scanning a QR Code. Once you have added any optional comments, press Submit and your lead will be recorded. Your captured lead information will be immediately reflected on the spreadsheet supplied in your lead generation email.</p>

        <div class="container"  style="margin-top: 40px; margin-bottom: 30px; text-align: center;">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#scanModal" id="launch" style="padding: 20px;"><i class="fa-solid fa-qrcode fa-2xl"></i></button>
          <span style="display: block; margin-top: 10px; font-size: 14px;" id="scan-label">Scan a QR Code</span>
        </div>
        <p style="margin-top: 20px;">If you have any concerns, please contact zainab@siberx.org and we will be more than happy to address them. Thank you for being a part of something special!</p>

        <p><b style="font-size: 20px;">#wearecyber</b>
          <span style="opacity: 50%; display: block;">siberX</span>
        </p>

      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
<script type="text/javascript">

  var win_width = $(window).width();
  $('.modal-dialog').css('max-width', win_width);
  $('.modal-dialog').css('width', 700);
  $('#circ').css('left', ((win_width < 700) ? win_width:700)/2 - 75);

  var security = "";
  var ticket_id = "";

    function decodeOnce(codeReader, selectedDeviceId) {
    codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {
        // properly decoded qr code
        console.log(result);

        var id = result.text.split(',');

        if (id[1] == undefined) {

            toastPopup('The QR code did not match the expected format.','danger');

            $('#close-modal').click();

        } else {

          security = id[0];
          ticket_id = id[1];

          $('#submit_button').prop('disabled', false);
          $('#comment-form').css('display', 'block');
          $('.modal-footer').css('display', 'block');
          $('#modalTitle').html('Add any optional comments and submit.');
          $('#qrcode-scanner').css('display','none');

        }

        codeReader.reset();


    }).catch((err) => {
        console.error(err)
    })
    }

    window.addEventListener('load', function () {
    let selectedDeviceId;
    const codeReader = new ZXing.BrowserQRCodeReader()
    console.log('ZXing code reader initialized')

    codeReader.getVideoInputDevices()
        .then((videoInputDevices) => {
        const sourceSelect = document.getElementById('sourceSelect')
        selectedDeviceId = videoInputDevices[0].deviceId
        if (videoInputDevices.length >= 1) {
            videoInputDevices.forEach((element) => {
            const sourceOption = document.createElement('option')
            sourceOption.text = element.label
            sourceOption.value = element.deviceId
            if (element.label.includes('back')) {
              sourceSelect.value('element.deviceId');
              selectedDeviceId = sourceSelect.value;
            }
            sourceSelect.appendChild(sourceOption)
            })

            sourceSelect.onchange = () => {
            selectedDeviceId = sourceSelect.value;
            };
        }

        document.getElementById('startButton').addEventListener('click', () => {

            decodeOnce(codeReader, selectedDeviceId);

            console.log(`Started decode from camera with id ${selectedDeviceId}`)
        })

        })
        .catch((err) => {
        console.error(err)
        })
    })
</script>

  <script type="text/javascript">

    const this_url = new URL(window.location.href);
    var vendor_id = this_url.searchParams.get('vendorID');
    if (vendor_id == undefined) {
      $('#vendor_code_display').text("Error: No security code detected.");
      $('#launch').prop('disabled', true);
      $('#launch').removeClass('btn-primary');
      $('#launch').addClass('btn-danger');
      $('#scan-label').text("Verify Security Code");
    } else {
      $('#vendor_code_display').text(vendor_id);
    }
    
    function startProcess(security, ticket_id, comment) {
	
      console.log("vendor: ", vendor_id);
      jQuery.support.cors = true;
      $.ajax({
        url: "https://leadgenx.siberxchange.live/generate-lead",
        type: "POST",
        crossDomain: true,
		dataType: "json",
        data: JSON.stringify({
		      uid: ticket_id,
          token: security, //security_code
          vendorID: vendor_id, //vendor_id
		      comment: comment
        }),
        headers: {
          "accept": "application/json",
          "Access-Control-Allow-Origin": "*"
        },
		method: 'POST',
		contentType: "application/json; charset=utf-8",
        success: function(data) {
          $('#close-modal').click();
		  if (data.response == "Record not found") {
			  toastPopup('No record matching the scanned QR code could be found.','danger');
      } else if (data.response == "Error - Database credentials invalid") {
			  toastPopup('There was a problem processing your request. Verify your security code.','danger');
      } else {
			toastPopup('The scanned QR code was successfully processed.','success');
		  }
        },
        error: function (response) {
          $('#close-modal').click();
          toastPopup('There was a problem processing the scanned QR code.','danger');
        }
      });
    }

    $(document).on("click", "#launch", function(e) {
	
	  $('.circle-loader').removeClass('load-complete');
	  $('.checkmark').hide();
	  $('#submit_button').prop('disabled', true);
	  $('#modalTitle').html('QR Code Scanner');
	  $('#comment-form').css('display', 'none');
	  $('.modal-footer').css('display', 'none');
    $('#status').html('Waiting for camera...');
    $('#qrcode-scanner').css('display','flex');

    });
	
	$(document).on("click", "#submit_button", function(e) {
		var comment = $('#comments').val();
		  
		startProcess(security, ticket_id, comment);
		console.log("security_code: ", security, ", ticket_id: ", ticket_id, ", comments: ", comment);

    $('#modalTitle').html('Powered by siberX');
    $('#qrcode-scanner').css('display','flex');
    $('#comment-form').css('display', 'none');
    $('.modal-footer').css('display', 'none');
    $('#status').html('Processing your submission...');
    $('#comments').val('');
	});
</script>

</body>
</html>